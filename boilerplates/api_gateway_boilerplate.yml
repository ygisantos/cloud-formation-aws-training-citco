AWSTemplateFormatVersion: 2010-09-09
Description: "Lambda API Gateway Example"

Parameters:
  restApiName:
    Type: "String"
    Description: "The name of our REST API"
    Default: "restApiSampleCfn"

  lambdaS3Bucket:
    Description: "S3 bucket of the lambda function"
    Type: "String"
    Default: "ysm-trn-cfn-scripts"




  # ==========================
  # HELLO LAMBDA PARAMS
  # ==========================
  helloFunctionName:
    Description: "Name of the Lambda Hello Function"
    Type: "String"
    Default: "fnLambdaHelloCfn"
  helloLambdaZipFile:
    Description: "Zip file path of the hello lambda function in S3"
    Type: "String"
    Default: "lambda_hello.zip"
  helloLambdaHandler:
    Description: "Handler of the hello lambda function"
    Type: "String"
    Default: "lambda_hello.handler"





  # ==========================
  # HI LAMBDA PARAMS
  # ==========================
  hiFunctionName:
    Description: "Name of the Lambda Hi Function"
    Type: "String"
    Default: "fnLambdaHiCfn"
  hiLambdaZipFile:
    Description: "Zip file path of the hi lambda function in S3"
    Type: "String"
    Default: "lambda_hi.zip"
  hiLambdaHandler:
    Description: "Handler of the hi lambda function"
    Type: "String"
    Default: "lambda_hi.handler"

Resources:
  restApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Description: "Sample Rest API using CFN"
      Name: !Ref restApiName







  # ==========================
  # /hello endpoint
  # ==========================
  restApiResourceHello:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt restApi.RootResourceId
      PathPart: "hello"
      RestApiId: !Ref restApi

  helloRestMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      ApiKeyRequired: false
      AuthorizationType: "NONE"
      HttpMethod: "GET"
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: "POST"
        Uri: !Join [
          "",
          [
            "arn:aws:apigateway:",
            !Ref "AWS::Region",
            ":lambda:path/2015-03-31/functions/",
            !GetAtt helloLambda.Arn,
            "/invocations"
          ]
        ]
      ResourceId: !Ref restApiResourceHello
      RestApiId: !Ref restApi

  helloLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref lambdaS3Bucket
        S3Key: !Join ["/", ["lambda", !Ref helloLambdaZipFile]]
      Description: "Sample Lambda Hello API using CFN"
      FunctionName: !Ref helloFunctionName
      Handler: !Ref helloLambdaHandler
      Role: !GetAtt HelloLambdaFunctionRole.Arn
      Runtime: "python3.12"
      Timeout: 60

  HelloLambdaFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      Description: !Join [" ", ["IAM Role for", !Ref helloFunctionName, "Lambda function"]]
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"
      RoleName: !Join ["-", [!Ref helloFunctionName, "lambda", "role"]]
      Policies:
        - PolicyName: !Join ["-", [!Ref helloFunctionName, "execution", "policy"]]
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "logs:CreateLogGroup"
                Resource:
                  - "arn:aws:logs:*:*:*"
              - Effect: Allow
                Action:
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  - !Join ["", ["arn:aws:logs:*:*:log-group:/aws/lambda/", !Ref helloFunctionName, ":*"]]

  apiLambdaInvokePermissionHello:
    Type: AWS::Lambda::Permission
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref helloLambda
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Join [
        "",
        [
          "arn:aws:execute-api:",
          !Ref "AWS::Region",
          ":",
          !Ref "AWS::AccountId",
          ":",
          !Ref restApi,
          "/*"
        ]
      ]





  # ==========================
  # /hi endpoint
  # ==========================
  restApiResourceHi:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt restApi.RootResourceId
      PathPart: "hi"
      RestApiId: !Ref restApi

  hiRestMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      ApiKeyRequired: false
      AuthorizationType: "NONE"
      HttpMethod: "GET"
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: "POST"
        Uri: !Join [
          "",
          [
            "arn:aws:apigateway:",
            !Ref "AWS::Region",
            ":lambda:path/2015-03-31/functions/",
            !GetAtt hiLambda.Arn,
            "/invocations"
          ]
        ]
      ResourceId: !Ref restApiResourceHi
      RestApiId: !Ref restApi

  hiLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref lambdaS3Bucket
        S3Key: !Join ["/", ["lambda", !Ref hiLambdaZipFile]]
      Description: "Sample Lambda Hi API using CFN"
      FunctionName: !Ref hiFunctionName
      Handler: !Ref hiLambdaHandler
      Role: !GetAtt HelloLambdaFunctionRole.Arn
      Runtime: "python3.12"
      Timeout: 60

  apiLambdaInvokePermissionHi:
    Type: AWS::Lambda::Permission
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref hiLambda
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Join [
        "",
        [
          "arn:aws:execute-api:",
          !Ref "AWS::Region",
          ":",
          !Ref "AWS::AccountId",
          ":",
          !Ref restApi,
          "/*"
        ]
      ]

  restApiStageDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref restApi
      StageName: "dev"

  restApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      DeploymentId: !Ref restApiStageDeployment
      Description: "Dev deployment stage"
      MethodSettings:
        - HttpMethod: "GET"
          ResourcePath: "/hello"
        - HttpMethod: "GET"
          ResourcePath: "/hi"
      RestApiId: !Ref restApi
